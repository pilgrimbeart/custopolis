import{r as E,e as V,f as Y,s as z,a as G,h as H,T as P,g as W,b as r,l as k,C as B,o as A,d as K,R as v}from"./session-CTnS1zJP.js";const $="custopolis-player-id",J=()=>{const t=localStorage.getItem($);if(t)return t;const e=crypto.randomUUID();return localStorage.setItem($,e),e},Q=t=>{const e=H();if(!t||typeof t!="object")return e;const n=t;for(let s=0;s<P;s+=1){const o=s.toString();typeof n[o]=="number"&&Number.isFinite(n[o])&&(e[o]=n[o])}return e},X=t=>{let e=0,n=Number.POSITIVE_INFINITY;for(let s=0;s<P;s+=1){const o=t[s.toString()]??0;o<n&&(n=o,e=s)}return e},Z=async(t,e,n)=>{const s=E(t,`sessions/${e}/players/${n}`),o=await V(s);if(o.exists()&&typeof o.val()?.teamId=="number")return o.val().teamId;let l=null;const j=E(t,`sessions/${e}/teamCounts`);if(!(await Y(j,q=>{const b=Q(q);return l=X(b),b[l.toString()]+=1,b})).committed||l===null)throw new Error("Team assignment transaction failed");return await z(s,{teamId:l,joinedAt:G()}),l},c=W(),tt=r("session-id"),C=r("team-id"),et=r("status"),R=r("app"),I=r("ready-screen"),nt=r("ready-text"),x=r("round-screen"),M=r("round-title"),O=r("round-clock"),U=r("customer-list"),st=r("action-educate"),ot=r("action-offer"),rt=r("action-fix");let S=null,d=null,i=null,a="-",N="-",u=null,m=null,f=null,D=0,L=null,h=null;const at=new URL("/custopolis/assets/generic_customer-t_NufhHG.png",import.meta.url).toString(),p=t=>{et.textContent=t},F=t=>{const e=K[t]??"#102432";document.documentElement.style.setProperty("--team-color",e),nt.textContent=`TEAM ${t+1} READY`,R.classList.add("hidden"),I.classList.remove("hidden"),x.classList.add("hidden")},lt=()=>{R.classList.add("hidden"),I.classList.add("hidden"),x.classList.remove("hidden")},g=()=>{R.classList.remove("hidden"),I.classList.add("hidden"),x.classList.add("hidden")},_=t=>{const e=Math.max(0,Math.floor(t/1e3)),n=Math.floor(e/60),s=e%60;return`${n.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},y=()=>{if(!i){O.textContent=_(v*1e3);return}const t=Date.now()+D,e=i+v*1e3-t;O.textContent=_(e)},T=t=>{f&&(window.clearInterval(f),f=null),t&&(y(),f=window.setInterval(y,250))},ct=()=>{/^round-\d+$/.test(a)?(lt(),T(!!i)):(T(!1),h!==null?F(h):g())},w=()=>{const t=L!==null;st.disabled=!t,ot.disabled=!t,rt.disabled=!t},it=()=>{U.innerHTML="";for(let t=0;t<B;t+=1){const e=document.createElement("button");e.type="button",e.className="customer-card";const n=document.createElement("img");n.src=at,n.alt="Customer";const s=document.createElement("span");s.textContent=`Customer ${t+1}`,e.appendChild(n),e.appendChild(s),e.addEventListener("click",()=>{L=t,document.querySelectorAll(".customer-card").forEach(o=>{o.classList.remove("selected")}),e.classList.add("selected"),w()}),U.appendChild(e)}};it();w();k(c,async t=>{if(tt.textContent=t??"Waiting...",!t){C.textContent="-",p("Waiting for host to start a cohort."),g(),S=null;return}if(t!==S){S=t,p("Assigning team..."),g();try{const e=J(),n=await Z(c,t,e);h=n,C.textContent=`Team ${n+1}`,p("Ready"),window.requestAnimationFrame(()=>F(n))}catch(e){console.error(e),C.textContent="-",p("Unable to join session.")}}});k(c,t=>{if(m&&(m(),m=null),u&&(u(),u=null),!t){a="-",d=null,i=null,T(!1);return}m=A(E(c,`sessions/${t}`),e=>{const n=e.val();if(a=n?.phase??"-",a!==N&&(L=null,document.querySelectorAll(".customer-card").forEach(s=>{s.classList.remove("selected")}),w(),N=a),d=typeof n?.currentRound=="number"?n.currentRound:null,i=typeof n?.roundStartedAt=="number"?n.roundStartedAt:null,d)M.textContent=`Round ${d}`;else{const s=a.match(/^round-(\d+)$/);M.textContent=s?`Round ${s[1]}`:"Round"}y(),ct()}),u=A(E(c,".info/serverTimeOffset"),e=>{D=typeof e.val()=="number"?e.val():0,y()})});
