import{r as y,d as b,e as C,s as E,f as S,h,T as g,g as w,b as r,l as x,a as A}from"./session-UX4NEy02.js";const f="custopolis-player-id",L=()=>{const t=localStorage.getItem(f);if(t)return t;const e=crypto.randomUUID();return localStorage.setItem(f,e),e},O=t=>{const e=h();if(!t||typeof t!="object")return e;const s=t;for(let n=0;n<g;n+=1){const a=n.toString();typeof s[a]=="number"&&Number.isFinite(s[a])&&(e[a]=s[a])}return e},R=t=>{let e=0,s=Number.POSITIVE_INFINITY;for(let n=0;n<g;n+=1){const a=t[n.toString()]??0;a<s&&(s=a,e=n)}return e},v=async(t,e,s)=>{const n=y(t,`sessions/${e}/players/${s}`),a=await b(n);if(a.exists()&&typeof a.val()?.teamId=="number")return a.val().teamId;let o=null;const I=y(t,`sessions/${e}/teamCounts`);if(!(await C(I,T=>{const c=O(T);return o=R(c),c[o.toString()]+=1,c})).committed||o===null)throw new Error("Team assignment transaction failed");return await E(n,{teamId:o,joinedAt:S()}),o},p=w(),N=r("session-id"),l=r("team-id"),P=r("status"),m=r("app"),u=r("ready-screen");let d=null;const i=t=>{P.textContent=t},U=t=>{const e=A[t]??"#102432";document.documentElement.style.setProperty("--team-color",e),m.classList.add("hidden"),u.classList.remove("hidden")};x(p,async t=>{if(N.textContent=t??"Waiting...",!t){l.textContent="-",i("Waiting for host to start a cohort."),m.classList.remove("hidden"),u.classList.add("hidden"),d=null;return}if(t!==d){d=t,i("Assigning team..."),m.classList.remove("hidden"),u.classList.add("hidden");try{const e=L(),s=await v(p,t,e);l.textContent=`Team ${s+1}`,i("Ready"),window.requestAnimationFrame(()=>U(s))}catch(e){console.error(e),l.textContent="-",i("Unable to join session.")}}});
