import{r as E,e as q,f as V,s as Y,a as z,h as G,T as _,g as H,b as r,l as P,C as W,o as A,d as B,R as v}from"./session-CTnS1zJP.js";const M="custopolis-player-id",K=()=>{const t=localStorage.getItem(M);if(t)return t;const e=crypto.randomUUID();return localStorage.setItem(M,e),e},J=t=>{const e=G();if(!t||typeof t!="object")return e;const n=t;for(let s=0;s<_;s+=1){const o=s.toString();typeof n[o]=="number"&&Number.isFinite(n[o])&&(e[o]=n[o])}return e},Q=t=>{let e=0,n=Number.POSITIVE_INFINITY;for(let s=0;s<_;s+=1){const o=t[s.toString()]??0;o<n&&(n=o,e=s)}return e},X=async(t,e,n)=>{const s=E(t,`sessions/${e}/players/${n}`),o=await q(s);if(o.exists()&&typeof o.val()?.teamId=="number")return o.val().teamId;let a=null;const F=E(t,`sessions/${e}/teamCounts`);if(!(await V(F,j=>{const b=J(j);return a=Q(b),b[a.toString()]+=1,b})).committed||a===null)throw new Error("Team assignment transaction failed");return await Y(s,{teamId:a,joinedAt:z()}),a},c=H(),Z=r("session-id"),S=r("team-id"),tt=r("status"),R=r("app"),I=r("ready-screen"),et=r("ready-text"),x=r("round-screen"),nt=r("round-title"),O=r("round-clock"),U=r("customer-list"),st=r("action-educate"),ot=r("action-offer"),rt=r("action-fix");let C=null,d=null,i=null,l="-",$="-",u=null,m=null,f=null,k=0,L=null,g=null;const at=new URL("/custopolis/assets/generic_customer-t_NufhHG.png",import.meta.url).toString(),p=t=>{tt.textContent=t},D=t=>{const e=B[t]??"#102432";document.documentElement.style.setProperty("--team-color",e),et.textContent=`TEAM ${t+1} READY`,R.classList.add("hidden"),I.classList.remove("hidden"),x.classList.add("hidden")},lt=()=>{R.classList.add("hidden"),I.classList.add("hidden"),x.classList.remove("hidden")},h=()=>{R.classList.remove("hidden"),I.classList.add("hidden"),x.classList.add("hidden")},N=t=>{const e=Math.max(0,Math.floor(t/1e3)),n=Math.floor(e/60),s=e%60;return`${n.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},y=()=>{if(!i){O.textContent=N(v*1e3);return}const t=Date.now()+k,e=i+v*1e3-t;O.textContent=N(e)},T=t=>{f&&(window.clearInterval(f),f=null),t&&(y(),f=window.setInterval(y,250))},ct=()=>{l==="round"?(lt(),T(!!i)):(T(!1),g!==null?D(g):h())},w=()=>{const t=L!==null;st.disabled=!t,ot.disabled=!t,rt.disabled=!t},it=()=>{U.innerHTML="";for(let t=0;t<W;t+=1){const e=document.createElement("button");e.type="button",e.className="customer-card";const n=document.createElement("img");n.src=at,n.alt="Customer";const s=document.createElement("span");s.textContent=`Customer ${t+1}`,e.appendChild(n),e.appendChild(s),e.addEventListener("click",()=>{L=t,document.querySelectorAll(".customer-card").forEach(o=>{o.classList.remove("selected")}),e.classList.add("selected"),w()}),U.appendChild(e)}};it();w();P(c,async t=>{if(Z.textContent=t??"Waiting...",!t){S.textContent="-",p("Waiting for host to start a cohort."),h(),C=null;return}if(t!==C){C=t,p("Assigning team..."),h();try{const e=K(),n=await X(c,t,e);g=n,S.textContent=`Team ${n+1}`,p("Ready"),window.requestAnimationFrame(()=>D(n))}catch(e){console.error(e),S.textContent="-",p("Unable to join session.")}}});P(c,t=>{if(m&&(m(),m=null),u&&(u(),u=null),!t){l="-",d=null,i=null,T(!1);return}m=A(E(c,`sessions/${t}`),e=>{const n=e.val();l=n?.phase??"-",l!==$&&(L=null,document.querySelectorAll(".customer-card").forEach(s=>{s.classList.remove("selected")}),w(),$=l),d=typeof n?.currentRound=="number"?n.currentRound:null,i=typeof n?.roundStartedAt=="number"?n.roundStartedAt:null,nt.textContent=d?`Round ${d}`:"Round",y(),ct()}),u=A(E(c,".info/serverTimeOffset"),e=>{k=typeof e.val()=="number"?e.val():0,y()})});
