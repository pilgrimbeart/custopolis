import{r as m,a as T,d as p,s as b,e as C,f as S,T as g,g as E,b as u,l as x}from"./session-CIAlojbw.js";const d="custopolis-player-id",w=()=>{const t=localStorage.getItem(d);if(t)return t;const e=crypto.randomUUID();return localStorage.setItem(d,e),e},A=t=>{const e=S();if(!t||typeof t!="object")return e;const a=t;for(let n=0;n<g;n+=1){const s=n.toString();typeof a[s]=="number"&&Number.isFinite(a[s])&&(e[s]=a[s])}return e},N=t=>{let e=0,a=Number.POSITIVE_INFINITY;for(let n=0;n<g;n+=1){const s=t[n.toString()]??0;s<a&&(a=s,e=n)}return e},h=async(t,e,a)=>{const n=m(t,`sessions/${e}/players/${a}`),s=await T(n);if(s.exists()&&typeof s.val()?.teamId=="number")return s.val().teamId;let o=null;const y=m(t,`sessions/${e}/teamCounts`);if(!(await p(y,I=>{const i=A(I);return o=N(i),i[o.toString()]+=1,i})).committed||o===null)throw new Error("Team assignment transaction failed");return await b(n,{teamId:o,joinedAt:C()}),o},f=E(),O=u("session-id"),c=u("team-id"),R=u("status");let l=null;const r=t=>{R.textContent=t};x(f,async t=>{if(O.textContent=t??"Waiting...",!t){c.textContent="-",r("Waiting for host to start a cohort."),l=null;return}if(t!==l){l=t,r("Assigning team...");try{const e=w(),a=await h(f,t,e);c.textContent=`Team ${a+1}`,r("Ready")}catch(e){console.error(e),c.textContent="-",r("Unable to join session.")}}});
